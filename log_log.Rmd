---
title: "R Notebook"
output:
  word_document: default
  html_document:
    df_print: paged
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
library(tidyverse)
library(ggfortify)
library(ggplot2)
library(readr)
library(dplyr)
library(viridis)
library(ggthemes)
library(DT)
library(magrittr)
library(qwraps2)
library(kableExtra)
library(ggalt)
library(WDI)
```




# BLR including WTP
```{r}
#data formatting 
choice <- read.csv("raw/version_to_package.csv", stringsAsFactors = TRUE) %>% 
  rename(survey_version = 1)

packages <- read.csv("raw/packages.csv", stringsAsFactors = TRUE)  %>% 
  rename(package = 1)

choice_package <- choice %>% 
  left_join(packages) %>% 
  mutate(choice = ifelse(package <= 16,1,2))


survey <- read.csv("raw/master_survey_resp.csv", stringsAsFactors = TRUE) %>% 
  select(survey_id, survey_version, country, choice, package_nopackage, starts_with("wtp"), starts_with("wtr"))

pack_yes <- survey %>% 
  filter(package_nopackage == 1) %>% 
  mutate(wtp = ifelse(wtp_4 == "y", 4,
                      ifelse(wtp_4 == "n", 3,
                             ifelse(wtp_3 =="n", 2,
                                    ifelse(wtp_2 =="n", 1, 0))))) %>% 
  select(-starts_with("wtp_"), -starts_with("wtr_"), -package_nopackage) %>% 
  left_join(choice_package) %>% 
  mutate(choice = 1)

pack_no <- survey %>% 
  filter(package_nopackage == 0) %>% 
  mutate(wtp = ifelse(wtr_4 == "y", -4,
                      ifelse(wtr_4 == "n", -5,
                             ifelse(wtr_3 =="y", -3,
                                    ifelse(wtr_2 =="y", -2, -1))))) %>% 
  select(-starts_with("wtp_"), -starts_with("wtr_"), -package_nopackage) %>% 
  left_join(choice_package) %>% 
  mutate(choice = 1)

pack_no_no <- pack_no %>% 
  mutate(wtp = (wtp + 1)) %>% 
  mutate(choice = 0)

pack_yes_no <- pack_yes %>% 
  filter(wtp != 4) %>% 
  mutate(wtp = (wtp + 1)) %>% 
  mutate(choice = 0)

bind_pre <- rbind(pack_no,pack_yes, pack_no_no, pack_yes_no) %>% 
  filter(wtp != -5)

other_pack <- bind_pre %>% 
  select(survey_id, survey_version, country,  choice) %>%
  mutate(choice = ifelse(choice == 1,2,1)) %>% 
  left_join(choice_package) %>% 
  mutate(choice = 0) %>% 
  mutate(wtp = 0)

bind <- rbind(bind_pre, other_pack) 

```

For IND

wtp_1 = $2.14
wtp_2 = $3.56
wtp_3 = $5.35
wtp_4 = $7.12

For MEX 

wtp_1 = $2.07
wtp_2 = $3.62
wtp_3 = $5.17
wtp_4 = $7.75

```{r}

bind_ind <- bind %>% 
  filter(country =="IND") %>% 
  mutate(wtp = ifelse(wtp == -4, -7.12,
                       ifelse(wtp == -3, -5.35, 
                              ifelse(wtp == -2, -3.56,
                                      ifelse(wtp == -1, -2.14, 
                                             ifelse(wtp == 0, 0, 
                                                    ifelse(wtp == 1, 2.14, 
                                                           ifelse(wtp == 2, 3.56, 
                                                                  ifelse(wtp == 3, 5.35, 7.12)))))))))

bind_mex <- bind %>% 
  filter(country =="MEX") %>% 
  mutate(wtp = ifelse(wtp == -4, -7.75,
                       ifelse(wtp == -3, -5.17, 
                              ifelse(wtp == -2, -3.62,
                                      ifelse(wtp == -1, -2.07, 
                                             ifelse(wtp == 0, 0, 
                                                    ifelse(wtp == 1, 2.07, 
                                                           ifelse(wtp == 2, 3.62, 
                                                                  ifelse(wtp == 3, 5.17, 7.75)))))))))

bind_wtp <- rbind(bind_mex,bind_ind) %>% 
  mutate(own = as.factor(own))


#making the df to be used for log-log
bind_log <- bind_wtp %>% 
  filter(choice == 1) %>% 
  mutate(sos = ifelse(sos==1,0,1)) %>% 
  mutate(info = ifelse(info == 2,0,1)) %>% 
  mutate(own = as.factor(own)) 

write.csv(bind_log, "int/log_log_wtp.csv", row.names = FALSE)

```


```{r}
wtp_distribution <- bind %>% 
  filter(choice == 1) %>% 
  select(wtp) %>%
  mutate(wtp_p4 = wtp + 4) %>% 
  mutate(log_wtp = log(wtp_p4)) %>% 
  gather(variable, value) 
  
wtp_distribution %>% 
 ggplot(aes(x = value, fill = variable)) +
    geom_bkde() +
    geom_rug() +
    scale_fill_viridis(guide = FALSE, discrete = TRUE) +
    facet_wrap(~variable, scales = "free") +
    theme_base()

```



```{r}
variables <- read_csv("int/variables.csv")

variables_log <- variables %>% 
  select(survey_id, country, community, income, years_fishing, age, education, boat_status)
```

Adding variables Income, Education, Years Fishing, Age, Country, Fishing Organization Members, Biggest problem facing fishery, fishing technology exposure, boat ownership.

Outlier detection
```{r}

income_summary <-
  list("Monthly Income" =
       list("min" = ~ min(.data$income),
            "max" = ~ max(.data$income),
            "mean (sd)" = ~ qwraps2::mean_sd(.data$income)))

income_na <- variables %>% 
  select(community, income) %>% 
  na.omit() %>% 
  mutate(community = as.factor(community))
  
by_com <- summary_table(dplyr::group_by(income_na, community), income_summary)
kable(by_com)

#HUGE distribution of income in IND, especially in WKB (10^7 difference) min is a single digit number, which does not make sense for Indonesia (Annual income for lowest income would be $0.0043) 

#Fixing for Wkb income error & currency conversion 

#0.000071 USD / 1 Indonesian Rupiah 
#0.052 USD / 1 Medican Peso

income_fix <- variables %>% 
  select(survey_id, country, community, income) %>%
  mutate(income = ifelse(country == "IND" & income <= 10, income*1000000, income)) %>% 
  mutate(currency = ifelse(country=="MEX", 0.052, 0.000071)) %>% 
  mutate(income_usd = currency*income*12) %>% 
  mutate(income_usd = round(income_usd, digits = 2))

usd_com_mean <-income_fix %>% 
  group_by(community) %>% 
  summarise(mean_income = mean(income_usd, na.rm = TRUE))

#adding in GDP per Capita conversion 
gdp_raw <- WDI(indicator = "NY.GDP.PCAP.KD", country=c("MX", "ID"), start = 2018, end = 2018) %>% 
  mutate(country = ifelse(country=="Mexico", "MEX", "IND")) %>% 
  rename(c = 1) %>% 
  select(-c, -year)

variables_income_fix <- income_fix %>% 
  left_join(usd_com_mean) %>%
  mutate(gf_income = ifelse(is.na(income), 1, 0)) %>% 
  mutate(income_usd = ifelse(is.na(income), mean_income, income_usd)) %>% 
  left_join(gdp_raw) %>% 
  mutate(gdp_prop = income_usd/NY.GDP.PCAP.KD)

gdp_prop<-variables_income_fix %>% 
  select(survey_id, gdp_prop, income_usd, NY.GDP.PCAP.KD)
```

Income from fishing, percent-gap filled
```{r}
fishincome <- variables %>%
  select(survey_id, country, community, income_fishing) %>%
  group_by(community) %>%
  summarise(mean_fishincome = round(mean(income_fishing, na.rm = TRUE),0))

variables_fishincome <- variables %>%
  select(survey_id, country, community, income_fishing) %>%
  mutate(income_fishing = as.numeric(income_fishing)) %>%
  left_join(fishincome) %>%
  mutate(gf_fishincome = ifelse(is.na(income_fishing), 1, 0)) %>% 
  mutate(income_fishing = ifelse(is.na(income_fishing), mean_fishincome, 
                                 ifelse(income_fishing == 0, mean_fishincome, income_fishing))) %>% 
  select(survey_id, country, community, income_fishing)

```


```{r}
#education
variables_edu <- variables %>% 
  select(survey_id, country, community, education) %>%  
  mutate(education = as.character(education)) %>% 
  mutate(education = ifelse(education == "other", "secondary", education)) %>%
  mutate(education = case_when(
    education == "no_formal" ~ "no_formal",
    education == "primary" | education == "secondary" ~ "formal",
    education == "university" | education == "vocational" ~ "higher"
  )) %>%
  mutate(education = as.factor(education))
```

```{r}
#gapfill means for each village for variable "fishing_org_members"... except for MNC.. gapfill with overall indonesia mean 
# 61.86538 is the average fishing org size from survey in IND round up to 62 

members_group <- variables %>%
  select(survey_id, country, community, fishing_org_members) %>%
  group_by(community) %>%
  summarise(mean_mem = round(mean(fishing_org_members, na.rm = TRUE),0))

variables_members <- variables %>%
  select(survey_id, country, community, fishing_org_members) %>%
  mutate(fishing_org_members = as.numeric(fishing_org_members)) %>%
  left_join(members_group) %>%
  mutate(gapfill_members = ifelse(is.na(fishing_org_members), 1, 0),
         fishing_org_members = case_when(
           is.na(fishing_org_members) & community != "MNC" ~ mean_mem,
           is.na(fishing_org_members & community == "MNC") ~ 62, 
           !is.na(fishing_org_members) ~ fishing_org_members)) %>%
      select(survey_id, country, community, fishing_org_members)

```

```{r}
## tidy up fishtech variable... combine into one.. they have exposure to a type of fishing technology, or they don't.

variables_fishtech <- variables %>%
    select(survey_id, country, community, starts_with("fishtech")) %>%
  mutate(fishtech = ifelse(fishtech_none == 1, 0, 1),
         fishtech = ifelse(is.na(fishtech_none), 0, fishtech)) %>%
        mutate(fishtech = ifelse(fishtech_vhf == 1 & fishtech == 0, 1, fishtech),
               fishtech = ifelse(is.na(fishtech_vhf), 0 , fishtech)) %>%
  select(survey_id, country, community, fishtech)


#new <- variables_fishtech %>% filter(fishtech_vhf == 1, sum(5:9) == 0)
```



Combining corrected variables (income and education) with years_fishing, age, community

```{r}
avg_years_fish_by_country <- variables %>%
  group_by(country) %>%
  summarise(mean(years_fishing)) ## use this value to gapfill for the one case where years_fishing > age... works because the mean is less than the age. 

variables_fishing_years <-
  variables %>%
  select(survey_id, country, community, years_fishing, age) %>%
  mutate(years_fishing = ifelse(years_fishing > age, 22.5, years_fishing))
```

simplify boat ownership 
```{r}
variables_boat_own <- variables %>% 
  mutate(boat_own = ifelse(boat_status == "own", 1,0)) %>% 
  select(survey_id, boat_own)
```

```{r}
problems<-variables %>% 
  select(survey_id, community, rank_one) %>% 
  mutate(rank = as.factor(rank_one)) %>% 
  group_by(community) %>% 
  count(rank)
#RAJ= MAX(weather), total NA = 4
#WKB =  MAX(IUU), total NA = 1

variables_rankone<-variables %>% 
  select(survey_id, community, rank_one) %>%
  mutate(rank_one = ifelse(is.na(rank_one) & community == "RAJ", "weather", 
                           ifelse(is.na(rank_one) & community =="WKB", "iuu", rank_one)))
```

```{r}
variables_log<-variables %>% 
  select(survey_id, country, community, years_fishing, age, boat_length_m, fishing_organization) %>% 
  left_join(variables_edu) %>% 
  left_join(gdp_prop) %>%
  left_join(variables_members) %>%
  left_join(variables_fishtech) %>%
  left_join(variables_fishing_years) %>% 
  left_join(variables_boat_own) %>% 
  left_join(variables_fishincome) %>% 
  left_join(variables_rankone)

#write.csv(variables_log, "int/log_log_variables.csv", row.names = FALSE)

```



```{r}
#variables_log <- read_csv("int/log_log_variables.csv")
#bind_log <- read_csv("int/log_log_wtp.csv")


bind_log_final <- bind_log %>%
  left_join(variables_log) %>%
  within(own <- relevel(own, ref = 4)) %>%
  within(education <- relevel(education, ref = "no_formal"))

wtpmin<- min(bind_log_final$wtp)

```

Include new summary function that incorporates clusters
```{r}
# load necessary packages for importing the function
library(RCurl)
 
# import the function from repository
url_robust <- "https://raw.githubusercontent.com/IsidoreBeautrelet/economictheoryblog/master/robust_summary.R"
eval(parse(text = getURL(url_robust, ssl.verifypeer = FALSE)),
     envir=.GlobalEnv)
```


```{r}
## Traditional linear regression:
basic_wtp_lm <- lm(wtp  ~ sos + info + own  + fishtech + factor(country) + rank_one + gdp_prop, data = bind_log_final)
summary(basic_wtp_lm, cluster = c("community"))

#AIC score is 916.8084, which is 800+ higher than other models. So no to the linear model

## Test log-log models:
wtp_lm <- lm(log(wtp + 1 - min(wtp)) ~ sos + info + own  + log(gdp_prop) + education + factor(country), data = bind_log_final)
summary(wtp_lm, cluster = c("community"))
autoplot(wtp_lm, which = 1:6, ncol = 3, label.size = 3)

wtp_lm_1 <- lm(log(wtp + 1 - min(wtp)) ~ sos + info + own  + log(years_fishing) + education + factor(country), data = bind_log_final)
summary(wtp_lm_1, cluster = "community")

wtp_lm_2 <- lm(log(wtp + 1 - min(wtp)) ~ sos + info + own  + log(boat_length_m) + education + factor(country), data = bind_log_final)
summary(wtp_lm_2, cluster = "community")

wtp_lm_3 <- lm(log(wtp + 1 - min(wtp)) ~ sos + info + own  + log(boat_length_m) + education + fishtech + factor(country), data = bind_log_final) 
summary(wtp_lm_3, cluster = "community")

wtp_lm_4 <- lm(log(wtp + 1 - min(wtp)) ~ sos + info + own  + log(gdp_prop) + education + fishtech + factor(country), data = bind_log_final) 
summary(wtp_lm_4, cluster = "community")

wtp_lm_5 <- lm(log(wtp + 1 - min(wtp)) ~ sos + info + own  + log(years_fishing) + education + fishtech + factor(country), data = bind_log_final)
summary(wtp_lm_5, cluster = c("community"))

wtp_lm_6 <- lm(log(wtp + 1 - min(wtp)) ~ sos + info + own  + log(gdp_prop) + log(years_fishing) + education + fishtech + factor(country), data = bind_log_final) 
summary(wtp_lm_6, cluster = "community")

wtp_lm_7 <- lm(log(wtp + 1 - min(wtp)) ~ sos + info + own  + education + fishtech + factor(country), data = bind_log_final) 
summary(wtp_lm_7, cluster = "community")

wtp_lm_8 <- lm(log(wtp + 1 - min(wtp)) ~ sos + info + own  + log(gdp_prop) + fishtech + factor(country), data = bind_log_final) 
summary(wtp_lm_8, cluster = "community")

wtp_lm_9 <- lm(log(wtp + 1 - min(wtp)) ~ sos + info + own  + log(gdp_prop) + fishtech + factor(country) + boat_own, data = bind_log_final) 
summary(wtp_lm_9, cluster = "community")

wtp_lm_10 <- lm(log(wtp + 1 - min(wtp)) ~ sos + info + own  + log(gdp_prop) + fishtech + factor(country) + fishing_organization, data = bind_log_final) 
summary(wtp_lm_10, cluster = "community")

wtp_lm_11 <- lm(log(wtp + 1 - min(wtp)) ~ sos + info + own  + fishtech + factor(country) + log(gdp_prop) + log(income_fishing), data = bind_log_final) 
summary(wtp_lm_11, cluster = "community")

wtp_lm_12 <- lm(log(wtp + 1 - min(wtp)) ~ sos + info + own  + fishtech + rank_one + log(gdp_prop), data = bind_log_final) 
summary(wtp_lm_12, cluster = "community")

wtp_lm_13 <- lm(log(wtp + 1 - min(wtp)) ~ sos + info + own  + fishtech + factor(country) + rank_one + log(gdp_prop) + education, data = bind_log_final) 
summary(wtp_lm_13, cluster = "community")

wtp_lm_14 <- lm(log(wtp + 1 - min(wtp)) ~ sos + info + own  + fishtech  + factor(country) + rank_one + education, data = bind_log_final) 
summary(wtp_lm_14, cluster = "community")

wtp_lm_15 <- lm(log(wtp + 1 - min(wtp)) ~ sos + info + own  + fishtech + rank_one + education, data = bind_log_final) 
summary(wtp_lm_15, cluster = "community")

wtp_lm_16 <- lm(log(wtp + 1 - min(wtp)) ~ sos + info + own  + fishtech  + rank_one + log(gdp_prop) + education, data = bind_log_final) 
summary(wtp_lm_16, cluster = "community")

AIC(basic_wtp_lm, wtp_lm, wtp_lm_1, wtp_lm_2, wtp_lm_3, wtp_lm_4, wtp_lm_5, wtp_lm_6, wtp_lm_7, wtp_lm_8, wtp_lm_9, wtp_lm_10, wtp_lm_11, wtp_lm_12, wtp_lm_13, wtp_lm_14, wtp_lm_15, wtp_lm_16) ## take the lowest one...  we will look at the best 3... 14, 15, 16


######## Random Hypotheses ########

## years_fishing adds more predictive power and has a lower p value than age -- use years_fishing 
## hypothesis: the longer someone has been fishing the more value they put into having this technology.

## income/gdp_prop: hypothesis: a higher income will place a higher value on the technology... model disagrees.. could have an interesting dialogue 

## education: a more educated person will likely want to pay more for this technology.. they will see more benefit in it. However, possible that we have some collinearity with education and income... should we debunk this? 

## fishing_org_members: hypothesis: a larger fishing organization size will place less value on tracking tech because they feel safer while fishing... more people around to help if something goes wrong. They also probably share more information with eachother anyways? <---- don't include this. Not all of our respondents were in a fishing organizatio..

## Test if education and income are correlated. 
ggplot(bind_log_final, aes(x = income_usd, y = wtp, color = education)) + geom_point() ## it seems that education vs income are pretty random... ok to both use in the model. 
```

Take a look at summary output (clustered on community) for our 3 best models: 
```{r}

summary(wtp_lm_14, cluster = c("community"))

summary(wtp_lm_15, cluster = c("community"))

summary(wtp_lm_16, cluster = c("community"))

```



```{r}
## Predict values for our best models
predict_lm14 <- cbind(bind_log_final, fitted = fitted(wtp_lm_14)) %>% 
  mutate(wtp_predict = (exp(fitted) - 1 + min(wtp)))

predict_lm15 <- cbind(bind_log_final, fitted = fitted(wtp_lm_15)) %>% 
  mutate(wtp_predict = (exp(fitted) - 1 + min(wtp)))

predict_lm16 <- cbind(bind_log_final, fitted = fitted(wtp_lm_16)) %>% 
  mutate(wtp_predict = (exp(fitted) - 1 + min(wtp)))
```


```{r}
# calculate exact percent change in WTP for our categorical variables for our best models
coef_lm_14 <- as.data.frame(wtp_lm_14$coefficients) %>%
  tibble::rownames_to_column("Beta") %>%
  mutate(on = exp(wtp_lm_14$coefficients) - 1 , off = exp(-wtp_lm_14$coefficients) - 1)

coef_lm_15 <- as.data.frame(wtp_lm_15$coefficients) %>%
  tibble::rownames_to_column("Beta") %>%
  mutate(on = exp(wtp_lm_15$coefficients) - 1 , off = exp(-wtp_lm_15$coefficients) - 1)

coef_lm_16 <- as.data.frame(wtp_lm_16$coefficients) %>%
  tibble::rownames_to_column("Beta") %>%
  mutate(on = exp(wtp_lm_16$coefficients) - 1 , off = exp(-wtp_lm_16$coefficients) - 1)

#write.csv(coef_lm_16, "output/wtp_results_16.csv", row.names = FALSE)

```

Run the best technology/best characteristics (BTBC), best tech/worst characteristics (BTWC), worst tech/best characteristics (WTBC), and worst tech/worst characteristics (WTWC) for models 14, 15, and 16.
```{r}
#### Model 14
# best tech: sos = 1, info = 0, own = 1
# worst tech = sos = 0, info = 1, own = 4
# best characteristics: fishtech = 1, country = "IND", rankone = "corruption", education = "higher"
# worst characteristics: fishtech = 0, country = MEX, rankone = weather, education = noformal
rownames <- c("BTBC", "BTWC", "WTBC", "WTWC")

BTBC_14 <- data.frame(sos = 1, info =  0, own = as.factor(1), fishtech = 1, country = "IND", rank_one = "corruption", education = "higher")

BTWC_14 <- data.frame( sos = 1, info =  0, own = as.factor(1), fishtech = 0, country = "MEX", rank_one = "weather", education = "no_formal")

WTBC_14 <- data.frame( sos = 0, info =  1, own = as.factor(4), fishtech = 1, country = "IND", rank_one = "corruption", education = "higher")

WTWC_14 <- data.frame( sos = 0, info =  1, own = as.factor(4), fishtech = 0, country = "MEX", rank_one = "weather", education = "no_formal")

newdata_14 <- rbind(BTBC_14, BTWC_14, WTBC_14, WTWC_14)

predict_14 <- predict(wtp_lm_14, newdata = newdata_14)
predict_14 <- data.frame((exp(predict_14) - 1 + wtpmin))
row.names(predict_14) <- rownames
#### Model 15
# best tech: sos = 1, info = 0, own = 1
# worst tech = sos = 0, info = 1, own = 4
# best characteristics: fishtech = 1, rankone = "corruption", education = "higher"
# worst characteristics: fishtech = 0, rankone = weather, education = noformal


BTBC_15 <- data.frame(sos = 1, info =  0, own = as.factor(1), fishtech = 1,  rank_one = "corruption", education = "higher")

BTWC_15 <- data.frame( sos = 1, info =  0, own = as.factor(1), fishtech = 0, rank_one = "weather", education = "no_formal")

WTBC_15 <- data.frame( sos = 0, info =  1, own = as.factor(4), fishtech = 1, rank_one = "corruption", education = "higher")

WTWC_15 <- data.frame( sos = 0, info =  1, own = as.factor(4), fishtech = 0, rank_one = "weather", education = "no_formal")

newdata_15 <- rbind(BTBC_15, BTWC_15, WTBC_15, WTWC_15)

predict_15 <- predict(wtp_lm_15, newdata = newdata_15)
predict_15 <- data.frame((exp(predict_15) - 1 + wtpmin))
row.names(predict_15) <- rownames

#### Model 15
# best tech: sos = 1, info = 0, own = 1
# worst tech = sos = 0, info = 1, own = 4
# best characteristics: fishtech = 1, rankone = "corruption", education = "higher"
# worst characteristics: fishtech = 0, rankone = weather, education = noformal
mingdpprop <- min(bind_log_final$gdp_prop)
maxgdpprop <- max(bind_log_final$gdp_prop)

BTBC_16 <- data.frame(sos = 1, info =  0, own = as.factor(1), fishtech = 1,  rank_one = "corruption", gdp_prop = mingdpprop, education = "higher")

BTWC_16 <- data.frame( sos = 1, info =  0, own = as.factor(1), fishtech = 0, rank_one = "weather", gdp_prop = maxgdpprop, education = "no_formal")

WTBC_16 <- data.frame( sos = 0, info =  1, own = as.factor(4), fishtech = 1, rank_one = "corruption", gdp_prop = mingdpprop, education = "higher")

WTWC_16 <- data.frame( sos = 0, info =  1, own = as.factor(4), fishtech = 0, rank_one = "weather",gdp_prop = maxgdpprop, education = "no_formal")

newdata_16 <- rbind(BTBC_16, BTWC_16, WTBC_16, WTWC_16)


predict_16 <- predict(wtp_lm_16, newdata = newdata_16)
predict_16 <- data.frame((exp(predict_16) - 1 + wtpmin))
# predict_15 <- cbind(Row.Names = rownames(rownames), predict_15)
row.names(predict_16) <- rownames

three_models_predictions <- cbind(lm_14 = predict_14, lm_15 = predict_15, lm_16 = predict_16)

write.csv(three_models_predictions, "output/best_worst_scenarios_models.csv")
```

## Run simulations for lm15

For each of the characteristic combinations presented, we will run the model for all 16 packages. For example, simulation 1 (fishtech == 1, rankone == "weather", education == "formal"), will be run 16 different times (one for each package). 

Simulation 1; most common characteristics from our sample: 
```{r}
## lm_15 run sim 1
sim_1_chars <- data.frame(fishtech = 1, rank_one = "weather", education = "formal")

packages_1 <- packages %>%
  filter(package <= 16)
packages_2 <- packages %>%
  filter(package >16)

packages_join <- inner_join(packages_1, packages_2, by = c("info", "sos", "own")) %>%
  mutate(sos = ifelse(sos==2,1,0), info=ifelse(info==2,0,1)) %>%
  select(-package.y) %>%
  mutate(own = as.factor(own))

sim_1_data <- merge(packages_join, sim_1_chars) %>%
  select(-package.x)

sim_1_predict <- predict(wtp_lm_15, newdata = sim_1_data)
sim_1_predict_actual <- data.frame(sim_1_data, predict_wtp = (exp(sim_1_predict) - 1 + wtpmin)) %>%
  mutate(simulation = 1)

```

Simulation 2; Most preferred characteristics to maximize WTP from our model:
```{r}
## lm_15 run sim 2
sim_2_chars <- data.frame(fishtech = 1, rank_one = "corruption", education = "higher")
sim_2_data <- merge(packages_join, sim_2_chars) %>%
  select(-package.x)

sim_2_predict <- predict(wtp_lm_15, newdata = sim_2_data)
sim_2_predict_actual <- data.frame(sim_2_data, predict_wtp = (exp(sim_2_predict) - 1 + wtpmin))%>%
  mutate(simulation = 2)
```

Simulation 3; Characteristics most commonly found in Indonesia from our sample:
```{r}
ind_chars <- bind_log_final %>%
  filter(country == "IND")
ind_fishtech <- group_by(ind_chars, fishtech) %>%
  summarise(length(fishtech)) ## 38 have exposure... meaning most common is to not have exposure. Plug fishtech = 0 into model.
ind_rankone <- group_by(ind_chars, rank_one) %>%
  summarise(length(rank_one)) ## weather biggest perceived problem in IND... rank_one = "weather"
ind_edu <- group_by(ind_chars, education) %>%
  summarise(length(education)) ## formal is most represented

sim_3_chars <- data.frame(fishtech = 0, rank_one = "weather", education = "formal")
sim_3_data <- merge(packages_join, sim_3_chars) %>%
  select(-package.x)

sim_3_predict <- predict(wtp_lm_15, newdata = sim_3_data)
sim_3_predict_actual <- data.frame(sim_3_data, predict_wtp = (exp(sim_3_predict) - 1 + wtpmin)) %>%
  mutate(simulation = 3)
```

Simulation 4; characteristics most commonly found in Mexico from our sample: 
```{r}
mex_chars <- bind_log_final %>%
  filter(country == "MEX")
mex_fishtech <- group_by(mex_chars, fishtech) %>%
  summarise(length(fishtech)) ## They all have exposure.. meaning most common is to not have exposure. Plug fishtech = 1 into model.
mex_rankone <- group_by(mex_chars, rank_one) %>%
  summarise(length(rank_one)) ## pollution biggest perceived problem in IND... rank_one = "pollution"
mex_edu <- group_by(mex_chars, education) %>%
  summarise(length(education)) ## formal is most represented

sim_4_chars <- data.frame(fishtech = 1, rank_one = "pollution", education = "formal")
sim_4_data <- merge(packages_join, sim_4_chars) %>%
  select(-package.x)

sim_4_predict <- predict(wtp_lm_15, newdata = sim_4_data)
sim_4_predict_actual <- data.frame(sim_4_data, predict_wtp = (exp(sim_4_predict) - 1 + wtpmin)) %>%
  mutate(simulation = 4)

simulations_lm_15 <- rbind(sim_1_predict_actual, sim_2_predict_actual, sim_3_predict_actual, sim_4_predict_actual)

#write.csv(simulations_lm_15, "output/simulations_lm_15.csv", row.names = FALSE)
```


## Run simulations for lm14

For each of the characteristic combinations presented, we will run the model for all 16 packages. For example, simulation 1 (fishtech == 1, rankone == "weather", education == "formal"), will be run 16 different times (one for each package). 

Simulation 1; most common characteristics from our sample; once for indonesia, once for mexico: 
```{r}
## lm_14 run sim 1
sim_1_chars_lm14 <- data.frame(fishtech = 1, rank_one = "weather", education = "formal")
mex <- data.frame(country = "MEX")
ind <- data.frame(country = "IND")


sim_1_data_lm14_mex <- merge(packages_join, sim_1_chars_lm14) %>%
  select(-package.x) %>%
  merge(mex) 
sim_1_data_lm14_ind <- merge(packages_join, sim_1_chars_lm14) %>%
  select(-package.x) %>%
  merge(ind)

sim_1_data_lm14 <- rbind(sim_1_data_lm14_ind, sim_1_data_lm14_mex)

sim_1_predict_lm14 <- predict(wtp_lm_14, newdata = sim_1_data_lm14)
sim_1_predict_actual_lm14 <- data.frame(sim_1_data_lm14, predict_wtp = (exp(sim_1_predict_lm14) - 1 + wtpmin)) %>%
  mutate(simulation = 1)

```

Simulation 2; Most preferred characteristics to maximize WTP from our model; once for indonesia, once for mexico:
```{r}
## lm_14 run sim 2
sim_2_chars_lm14 <- data.frame(fishtech = 1, rank_one = "corruption", education = "higher")
mex <- data.frame(country = "MEX")
ind <- data.frame(country = "IND")


sim_2_data_lm14_mex <- merge(packages_join, sim_2_chars_lm14) %>%
  select(-package.x) %>%
  merge(mex) 
sim_2_data_lm14_ind <- merge(packages_join, sim_2_chars_lm14) %>%
  select(-package.x) %>%
  merge(ind)

sim_2_data_lm14 <- rbind(sim_2_data_lm14_ind, sim_2_data_lm14_mex)

sim_2_predict_lm14 <- predict(wtp_lm_14, newdata = sim_2_data_lm14)
sim_2_predict_actual_lm14 <- data.frame(sim_2_data_lm14, predict_wtp = (exp(sim_2_predict_lm14) - 1 + wtpmin)) %>%
  mutate(simulation = 2)

simulations_lm_14 <- rbind(sim_1_predict_actual_lm14, sim_2_predict_actual_lm14)

#write.csv(simulations_lm_14, "output/simulations_lm_14.csv", row.names = FALSE)
```

## Run simulations for lm16

For each of the characteristic combinations presented, we will run the model for all 16 packages. For example, simulation 1 (fishtech == 1, rankone == "weather", education == "formal", gdp_prop = ), will be run 16 different times (one for each package). 

Simulation 1; most common characteristics from our sample: 
```{r}
## lm_16 run sim 1
avg_gdp_prop <- mean(bind_log_final$gdp_prop)

sim_1_chars_lm16 <- data.frame(fishtech = 1, rank_one = "weather", education = "formal", gdp_prop = avg_gdp_prop)

sim_1_data_lm16 <- merge(packages_join, sim_1_chars_lm16) %>%
  select(-package.x)

sim_1_predict_lm16 <- predict(wtp_lm_16, newdata = sim_1_data_lm16)
sim_1_predict_actual_lm16 <- data.frame(sim_1_data_lm16, predict_wtp = (exp(sim_1_predict_lm16) - 1 + wtpmin)) %>%
  mutate(simulation = 1)

```

Simulation 2; Most preferred characteristics to maximize WTP from our model:
```{r}
## lm_16 run sim 2
min_gdp_prop <- min(bind_log_final$gdp_prop)

sim_2_chars_lm16 <- data.frame(fishtech = 1, rank_one = "corruption", education = "higher", gdp_prop = min_gdp_prop)
sim_2_data_lm16 <- merge(packages_join, sim_2_chars_lm16) %>%
  select(-package.x)

sim_2_predict_lm16 <- predict(wtp_lm_16, newdata = sim_2_data_lm16)
sim_2_predict_actual_lm16 <- data.frame(sim_2_data_lm16, predict_wtp = (exp(sim_2_predict_lm16) - 1 + wtpmin))%>%
  mutate(simulation = 2)
```

Simulation 3; Characteristics most commonly found in Indonesia from our sample:
```{r}
ind_chars <- bind_log_final %>%
  filter(country == "IND")

ind_avg_gdpprop <- mean(ind_chars$gdp_prop)
ind_fishtech <- group_by(ind_chars, fishtech) %>%
  summarise(length(fishtech)) ## 38 have exposure... meaning most common is to not have exposure. Plug fishtech = 0 into model.
ind_rankone <- group_by(ind_chars, rank_one) %>%
  summarise(length(rank_one)) ## weather biggest perceived problem in IND... rank_one = "weather"
ind_edu <- group_by(ind_chars, education) %>%
  summarise(length(education)) ## formal is most represented

sim_3_chars_lm16 <- data.frame(fishtech = 0, rank_one = "weather", education = "formal", gdp_prop = ind_avg_gdpprop)
sim_3_data_lm16 <- merge(packages_join, sim_3_chars_lm16) %>%
  select(-package.x)

sim_3_predict_lm16 <- predict(wtp_lm_16, newdata = sim_3_data_lm16)
sim_3_predict_actual_lm16 <- data.frame(sim_3_data_lm16, predict_wtp = (exp(sim_3_predict_lm16) - 1 + wtpmin)) %>%
  mutate(simulation = 3)
```

Simulation 4; characteristics most commonly found in Mexico from our sample: 
```{r}
mex_chars <- bind_log_final %>%
  filter(country == "MEX")
mex_avg_gdpprop <- mean(mex_chars$gdp_prop)
mex_fishtech <- group_by(mex_chars, fishtech) %>%
  summarise(length(fishtech)) ## They all have exposure.. meaning most common is to not have exposure. Plug fishtech = 1 into model.
mex_rankone <- group_by(mex_chars, rank_one) %>%
  summarise(length(rank_one)) ## pollution biggest perceived problem in IND... rank_one = "pollution"
mex_edu <- group_by(mex_chars, education) %>%
  summarise(length(education)) ## formal is most represented

sim_4_chars_lm16 <- data.frame(fishtech = 1, rank_one = "pollution", education = "formal", gdp_prop = mex_avg_gdpprop)
sim_4_data_lm16 <- merge(packages_join, sim_4_chars_lm16) %>%
  select(-package.x)

sim_4_predict_lm16 <- predict(wtp_lm_16, newdata = sim_4_data_lm16)
sim_4_predict_actual_lm16 <- data.frame(sim_4_data_lm16, predict_wtp = (exp(sim_4_predict_lm16) - 1 + wtpmin)) %>%
  mutate(simulation = 4)

simulations_lm_16 <- rbind(sim_1_predict_actual_lm16, sim_2_predict_actual_lm16, sim_3_predict_actual_lm16, sim_4_predict_actual_lm16)

#write.csv(simulations_lm_16, "output/simulations_lm_16.csv", row.names = FALSE)
```

### Ultimate Simulation
```{r}
sos <- c(0,1)
info <- c(0,1)
own <- c("1", "2", "3", "4")
fishtech <- c(0,1)
rank_one <- c("corruption", "pollution", "weather", "iuu")
education <- c("no_formal", "formal", "higher")

simulation_data <- expand.grid(sos = sos, info = info, own = own,fishtech =  fishtech, rank_one = rank_one, education = education)

simulation_all_lm15 <- data.frame(simulation_data, wtp_predict = exp(predict(wtp_lm_15, newdata = simulation_data)) - 1 + wtpmin) 

## now we have a dataframe of every possible combination of our variables in lm_15 and a predicted wtp from lm_15...
#write.csv(simulation_all_lm15, "output/lm_15_allcombo_predictions.csv")
```



How to interpret our coefficients:
The coefficient on a dummy variable with a log-transformed Y variable is interpreted as the percentage change in Y associated with having the dummy variable characteristic relative to the omitted category, with all other included X variables held fixed.

Justification for using a log-log model:
For interpretation. In economics, we are sometimes interested how a percentage change in x affects the percentage change in y. This called elasticity. We can estimate elasticity (f) by using a log-log model


Notes and relevant links:

 - https://stats.stackexchange.com/questions/240572/log-log-regression-dummy-variable-and-index
 
 - https://rpubs.com/rslbliss/fixed_effects
 
 - https://blogs.sas.com/content/iml/2011/04/27/log-transformations-how-to-handle-negative-data-values.html
 
 - https://stats.idre.ucla.edu/other/mult-pkg/faq/general/faqhow-do-i-interpret-a-regression-model-when-some-variables-are-log-transformed/

By controlling for female in the original equation, we are estimating the relationship between hours worked and weekly salary having adjusted for systematic differences in hours worked and weekly salary between females and males. (A bit wordy, yes, but this is my preferred interpretation.)

Fixed effects (in the context of this page) are just a fancy extension of the idea of controlling for a categorical variable.

As a presentation note, people often do not present the actual fixed effects estimates in their results. They often just note that fixed effects were included, but don’t present the actual numbers because they are not typically interpreted.





