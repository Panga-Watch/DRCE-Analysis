---
title: "R Notebook"
output:
  word_document: default
  html_document:
    df_print: paged
---

```{r}
library(tidyverse)
library(ggfortify)
library(ggplot2)
library(readr)
library(dplyr)
library(viridis)
library(ggthemes)
library(DT)
library(magrittr)
library(qwraps2)
library(kableExtra)
library(ggalt)
library(WDI)
library(foreign)
library(GGally)
library(survival)

```

# BLR including WTP
```{r}
#data formatting 
choice <- read.csv("raw/version_to_package.csv", stringsAsFactors = TRUE) %>% 
  rename(survey_version = 1)

packages <- read.csv("raw/packages.csv", stringsAsFactors = TRUE)  %>% 
  rename(package = 1)

choice_package <- choice %>% 
  left_join(packages) %>% 
  mutate(choice = ifelse(package <= 16,1,2))


survey <- read.csv("raw/master_survey_resp.csv", stringsAsFactors = TRUE) %>% 
  select(survey_id, survey_version, country, choice, package_nopackage, starts_with("wtp"), starts_with("wtr"))

pack_yes <- survey %>% 
  filter(package_nopackage == 1) %>% 
  mutate(wtp = ifelse(wtp_4 == "y", 4,
                      ifelse(wtp_4 == "n", 3,
                             ifelse(wtp_3 =="n", 2,
                                    ifelse(wtp_2 =="n", 1, 0))))) %>% 
  select(-starts_with("wtp_"), -starts_with("wtr_"), -package_nopackage) %>% 
  left_join(choice_package) %>% 
  mutate(choice = 1)

pack_no <- survey %>% 
  filter(package_nopackage == 0) %>% 
  mutate(wtp = ifelse(wtr_4 == "y", -4,
                      ifelse(wtr_4 == "n", -5,
                             ifelse(wtr_3 =="y", -3,
                                    ifelse(wtr_2 =="y", -2, -1))))) %>% 
  select(-starts_with("wtp_"), -starts_with("wtr_"), -package_nopackage) %>% 
  left_join(choice_package) %>% 
  mutate(choice = 1)

pack_no_no <- pack_no %>% 
  mutate(wtp = (wtp + 1)) %>% 
  mutate(choice = 0)

pack_yes_no <- pack_yes %>% 
  filter(wtp != 4) %>% 
  mutate(wtp = (wtp + 1)) %>% 
  mutate(choice = 0)

bind_pre <- rbind(pack_no,pack_yes, pack_no_no, pack_yes_no) %>% 
  filter(wtp != -5)

other_pack <- bind_pre %>% 
  select(survey_id, survey_version, country,  choice) %>%
  mutate(choice = ifelse(choice == 1,2,1)) %>% 
  left_join(choice_package) %>% 
  mutate(choice = 0) %>% 
  mutate(wtp = 0)

bind <- rbind(bind_pre, other_pack) 

```

For IND

wtp_1 = $2.14
wtp_2 = $3.56
wtp_3 = $5.35
wtp_4 = $7.12

For MEX 

wtp_1 = $2.07
wtp_2 = $3.62
wtp_3 = $5.17
wtp_4 = $7.75

```{r}
#wtp == -5, -100, 
bind_ind <- bind %>% 
  filter(country =="IND") %>% 
  mutate(wtp = 
                      ifelse(wtp == -4, -7.12,
                       ifelse(wtp == -3, -5.35, 
                              ifelse(wtp == -2, -3.56,
                                      ifelse(wtp == -1, -2.14, 
                                             ifelse(wtp == 0, 0, 
                                                    ifelse(wtp == 1, 2.14, 
                                                           ifelse(wtp == 2, 3.56, 
                                                                  ifelse(wtp == 3, 5.35, 7.12)))))))))
#ifelse(wtp == -5, -100,
bind_mex <- bind %>% 
  filter(country =="MEX") %>% 
  mutate(wtp =
                    ifelse(wtp == -4, -7.75,
                       ifelse(wtp == -3, -5.17, 
                              ifelse(wtp == -2, -3.62,
                                      ifelse(wtp == -1, -2.07, 
                                             ifelse(wtp == 0, 0, 
                                                    ifelse(wtp == 1, 2.07, 
                                                           ifelse(wtp == 2, 3.62, 
                                                                  ifelse(wtp == 3, 5.17, 7.75)))))))))

bind_wtp <- rbind(bind_mex,bind_ind) %>% 
  mutate(own = as.factor(own))


#making the df to be used for log-log
bind_log <- bind_wtp %>% 
  filter(choice == 1) %>% 
  mutate(sos = ifelse(sos==1,0,1)) %>% 
  mutate(info = ifelse(info == 2,0,1)) %>% 
  mutate(own = as.factor(own)) 
mean(bind_log$wtp)
#write.csv(bind_log, "int/log_log_wtp.csv", row.names = FALSE)
```


```{r}
wtp_distribution <- bind %>% 
  filter(choice == 1) %>% 
  select(wtp) %>%
  mutate(wtp_p4 = wtp + 4) %>% 
  mutate(log_wtp = log(wtp_p4)) %>% 
  gather(variable, value) 
  
wtp_distribution %>% 
 ggplot(aes(x = value, fill = variable)) +
    geom_bkde() +
    geom_rug() +
    scale_fill_viridis(guide = FALSE, discrete = TRUE) +
    facet_wrap(~variable, scales = "free") +
    theme_base()

```



```{r}
variables <- read_csv("int/variables.csv")

variables_log <- variables %>% 
  select(survey_id, country, community, income, years_fishing, age, education, boat_status)
```

Adding variables Income, Education, Years Fishing, Age, Country, Fishing Organization Members, Biggest problem facing fishery, fishing technology exposure, boat ownership.

Outlier detection
```{r}

income_summary <-
  list("Monthly Income" =
       list("min" = ~ min(.data$income),
            "max" = ~ max(.data$income),
            "mean (sd)" = ~ qwraps2::mean_sd(.data$income)))

income_na <- variables %>% 
  select(community, income) %>% 
  na.omit() %>% 
  mutate(community = as.factor(community))
  
by_com <- summary_table(dplyr::group_by(income_na, community), income_summary)
kable(by_com)

#HUGE distribution of income in IND, especially in WKB (10^7 difference) min is a single digit number, which does not make sense for Indonesia (Annual income for lowest income would be $0.0043) 

#Fixing for Wkb income error & currency conversion 

#0.000071 USD / 1 Indonesian Rupiah 
#0.052 USD / 1 Medican Peso

income_fix <- variables %>% 
  select(survey_id, country, community, income) %>%
  mutate(income = ifelse(country == "IND" & income <= 10, income*1000000, income)) %>% 
  mutate(currency = ifelse(country=="MEX", 0.052, 0.000071)) %>% 
  mutate(income_usd = currency*income*12) %>% 
  mutate(income_usd = round(income_usd, digits = 2))

usd_com_mean <-income_fix %>% 
  group_by(community) %>% 
  summarise(mean_income = mean(income_usd, na.rm = TRUE))

#adding in GDP per Capita conversion 
gdp_raw <- WDI(indicator = "NY.GDP.PCAP.KD", country=c("MX", "ID"), start = 2018, end = 2018) %>% 
  mutate(country = ifelse(country=="Mexico", "MEX", "IND")) %>% 
  rename(c = 1) %>% 
  select(-c, -year)

variables_income_fix <- income_fix %>% 
  left_join(usd_com_mean) %>%
  mutate(gf_income = ifelse(is.na(income), 1, 0)) %>% 
  mutate(income_usd = ifelse(is.na(income), mean_income, income_usd)) %>% 
  left_join(gdp_raw) %>% 
  mutate(gdp_prop = income_usd/NY.GDP.PCAP.KD)

gdp_prop<-variables_income_fix %>% 
  select(survey_id, gdp_prop, income_usd, NY.GDP.PCAP.KD)
```

Income from fishing, percent-gap filled
```{r}
fishincome <- variables %>%
  select(survey_id, country, community, income_fishing) %>%
  group_by(community) %>%
  summarise(mean_fishincome = round(mean(income_fishing, na.rm = TRUE),0))

variables_fishincome <- variables %>%
  select(survey_id, country, community, income_fishing) %>%
  mutate(income_fishing = as.numeric(income_fishing)) %>%
  left_join(fishincome) %>%
  mutate(gf_fishincome = ifelse(is.na(income_fishing), 1, 0)) %>% 
  mutate(income_fishing = ifelse(is.na(income_fishing), mean_fishincome, 
                                 ifelse(income_fishing == 0, mean_fishincome, income_fishing))) %>% 
  select(survey_id, country, community, income_fishing)

```


```{r}
#education
variables_edu <- variables %>% 
  select(survey_id, country, community, education) %>%  
  mutate(education = as.character(education)) %>% 
  mutate(education = ifelse(education == "other", "secondary", education)) %>%
  mutate(education = case_when(
    education == "no_formal" ~ "no_formal",
    education == "primary" | education == "secondary" ~ "formal",
    education == "university" | education == "vocational" ~ "higher"
  )) %>%
  mutate(education = as.factor(education))
```

```{r}
#gapfill means for each village for variable "fishing_org_members"... except for MNC.. gapfill with overall indonesia mean 
# 61.86538 is the average fishing org size from survey in IND round up to 62 

members_group <- variables %>%
  select(survey_id, country, community, fishing_org_members) %>%
  group_by(community) %>%
  summarise(mean_mem = round(mean(fishing_org_members, na.rm = TRUE),0))

variables_members <- variables %>%
  select(survey_id, country, community, fishing_org_members) %>%
  mutate(fishing_org_members = as.numeric(fishing_org_members)) %>%
  left_join(members_group) %>%
  mutate(gapfill_members = ifelse(is.na(fishing_org_members), 1, 0),
         fishing_org_members = case_when(
           is.na(fishing_org_members) & community != "MNC" ~ mean_mem,
           is.na(fishing_org_members & community == "MNC") ~ 62, 
           !is.na(fishing_org_members) ~ fishing_org_members)) %>%
      select(survey_id, country, community, fishing_org_members)

```

```{r}
## tidy up fishtech variable... combine into one.. they have exposure to a type of fishing technology, or they don't.

variables_fishtech <- variables %>%
    select(survey_id, country, community, starts_with("fishtech")) %>%
  mutate(fishtech = ifelse(fishtech_none == 1, 0, 1),
         fishtech = ifelse(is.na(fishtech_none), 0, fishtech)) %>%
        mutate(fishtech = ifelse(fishtech_vhf == 1 & fishtech == 0, 1, fishtech),
               fishtech = ifelse(is.na(fishtech_vhf), 0 , fishtech)) %>%
  select(survey_id, country, community, fishtech)

```



Combining corrected variables (income and education) with years_fishing, age, community

```{r}
avg_years_fish_by_country <- variables %>%
  group_by(country) %>%
  summarise(mean(years_fishing)) ## use this value to gapfill for the one case where years_fishing > age... works because the mean is less than the age. 

variables_fishing_years <-
  variables %>%
  select(survey_id, country, community, years_fishing, age) %>%
  mutate(years_fishing = ifelse(years_fishing > age, 22.5, years_fishing))
```

simplify boat ownership 
```{r}
variables_boat_own <- variables %>% 
  mutate(boat_own = ifelse(boat_status == "own", 1,0)) %>% 
  select(survey_id, boat_own)
```

```{r}
problems<-variables %>% 
  select(survey_id, community, rank_one) %>% 
  mutate(rank = as.factor(rank_one)) %>% 
  group_by(community) %>% 
  count(rank)

variables_rankone<-variables %>% 
  select(survey_id, community, rank_one) %>%
  mutate(rank_one = ifelse(is.na(rank_one) & community == "RAJ", "weather", 
                           ifelse(is.na(rank_one) & community =="WKB", "iuu", rank_one)))
```

```{r}
variables_log<-variables %>% 
  select(survey_id, country, community, years_fishing, age, boat_length_m, fishing_organization) %>% 
  left_join(variables_edu) %>% 
  left_join(gdp_prop) %>%
  left_join(variables_members) %>%
  left_join(variables_fishtech) %>%
  left_join(variables_fishing_years) %>% 
  left_join(variables_boat_own) %>% 
  left_join(variables_fishincome) %>% 
  left_join(variables_rankone)

#write.csv(variables_log, "int/log_log_variables.csv", row.names = FALSE)

```



```{r}
#variables_log <- read_csv("int/log_log_variables.csv")
#bind_log <- read_csv("int/log_log_wtp.csv")


bind_log_final <- bind_log %>%
  left_join(variables_log) %>%
  within(own <- relevel(own, ref = 4)) %>%
  within(education <- relevel(education, ref = "no_formal"))

wtpmin<- min(bind_log_final$wtp)

```

Include new summary function that incorporates clusters
```{r}
# load necessary packages for importing the function
library(RCurl)
 
# import the function from repository
url_robust <- "https://raw.githubusercontent.com/IsidoreBeautrelet/economictheoryblog/master/robust_summary.R"
eval(parse(text = getURL(url_robust, ssl.verifypeer = FALSE)),
     envir=.GlobalEnv)
```

Prep data for interval regression
```{r}
## Make it into interval data... and run models again.. without log..


# For IND
# wtp_1 = $2.14
# wtp_2 = $3.56
# wtp_3 = $5.35
# wtp_4 = $7.12

# For MEX 
# wtp_1 = $2.07
# wtp_2 = $3.62
# wtp_3 = $5.17
# wtp_4 = $7.75


#wtp == -100, -7.75,

bind_interval_mex <- bind_log_final %>% 
  filter(country == "MEX") %>%
  mutate(wtp_upper = 
                    ifelse(wtp == -7.75, -5.17, 
                       ifelse(wtp == -5.17, -3.62,
                              ifelse(wtp == -3.62, -2.07,
                                      ifelse(wtp == -2.07, 0,
                                             ifelse(wtp == 0, 2.07, 
                                                    ifelse(wtp == 2.07, 3.62,
                                                           ifelse(wtp == 3.62, 5.17,
                                                                  ifelse(wtp == 5.17, 7.75, 13.33))))))))) ## chose 13.33 as the upper bound because this is two cell phone bill increments higher than 7.75
                                                                        
#ifelse(wtp == -100, -7.12,                                                                       
 bind_interval_ind <- bind_log_final %>%
       filter(country == "IND") %>%
   mutate(wtp_upper = 
          ifelse(wtp == -7.12, -5.35,
            ifelse(wtp == -5.35, -3.56, 
              ifelse(wtp == -3.56, -2.14,
                ifelse(wtp == -2.14, 0, 
                  ifelse(wtp == 0, 2.14, 
                    ifelse(wtp == 2.14, 3.56, 
                      ifelse(wtp == 3.56, 5.35, 
                        ifelse(wtp == 5.35, 7.12, 11.02))))))))) ## chose 11.02 as the upper bound because this is two cell phone bill increments higher than 7.12
  

bind_interval_final <- rbind(bind_interval_ind, bind_interval_mex) %>%
  rename("wtp_lower" = "wtp") 

intervals <- with(bind_interval_final, Surv(wtp_lower, wtp_upper, event = rep(3, nrow(bind_interval_final)), type = "interval"))
intervals

```

Run regressions on interval data
```{r}
int_tech <- survreg(intervals ~ sos + info + own, data = bind_interval_final, dist = "gaussian")
summary(int_tech)

int <- survreg(intervals ~ sos + info + own + education + gdp_prop, data = bind_interval_final, dist = "gaussian")
summary(int)

int_1 <- survreg(intervals ~ sos + info + own + education + years_fishing, data = bind_interval_final, dist = "gaussian")
summary(int_1, cluster = c("community"))

int_2 <- survreg(intervals ~ sos + info + own + education + boat_length_m, data = bind_interval_final, dist = "gaussian")
summary(int_2, cluster = c("community"))

int_3 <- survreg(intervals ~ sos + info + own + education + boat_length_m + fishtech, data = bind_interval_final, dist = "gaussian")
summary(int_3, cluster = c("community"))

int_4 <- survreg(intervals ~ sos + info + own + education  + fishtech + gdp_prop, data = bind_interval_final, dist = "gaussian")
summary(int_4, cluster = c("community"))

int_5 <- survreg(intervals ~ sos + info + own + education + years_fishing + fishtech, data = bind_interval_final, dist = "gaussian")
summary(int_5, cluster = c("community"))

int_6 <- survreg(intervals ~ sos + info + own + education + years_fishing + gdp_prop + fishtech, data = bind_interval_final, dist = "gaussian")
summary(int_6, cluster = c("community"))

int_7 <- survreg(intervals ~ sos + info + own + education +  fishtech, data = bind_interval_final, dist = "gaussian")
summary(int_7, cluster = c("community"))

int_8 <- survreg(intervals ~ sos + info + own + gdp_prop +  fishtech, data = bind_interval_final, dist = "gaussian")
summary(int_8, cluster = c("community"))

int_9 <- survreg(intervals ~ sos + info + own + gdp_prop +  fishtech + boat_own, data = bind_interval_final, dist = "gaussian")
summary(int_9, cluster = c("community"))

int_10 <- survreg(intervals ~ sos + info + own + gdp_prop +  fishtech + fishing_organization, data = bind_interval_final, dist = "gaussian")
summary(int_10, cluster = c("community"))

int_11 <- survreg(intervals ~ sos + info + own + gdp_prop +  fishtech + income_fishing, data = bind_interval_final, dist = "gaussian")
summary(int_11, cluster = c("community"))

int_12 <- survreg(intervals ~ sos + info + own + gdp_prop +  fishtech + rank_one, data = bind_interval_final, dist = "gaussian")
summary(int_12, cluster = c("community"))

int_13 <- survreg(intervals ~ sos + info + own +  fishtech + rank_one + fishing_organization, data = bind_interval_final, dist = "gaussian")
summary(int_13, cluster = c("community"))

int_15 <- survreg(intervals ~ sos + info + own + rank_one + fishtech + education, data = bind_interval_final, dist = "gaussian") ## normal distribution... WTP does look normal
summary(int_15, cluster = c("community"))

int_16 <- survreg(intervals ~ sos + info + own + rank_one + fishtech + education + gdp_prop, data = bind_interval_final, dist = "gaussian") ## normal distribution... WTP does look normal
summary(int_16, cluster = c("community"))

#save(int_15, file = "output/int_15.rda") # save best model

#save(int_16, file = "output/int_16_gdp_prop.rda") # save best model with gdp_prop

AIC(int_tech, int, int_1, int_2, int_3, int_4, int_5, int_6, int_7, int_8, int_9, int_10, int_11, int_12, int_13, int_15, int_16)
```






