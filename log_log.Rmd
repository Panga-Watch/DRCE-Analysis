---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
library(tidyverse)
library(ggfortify)
library(ggplot2)
library(readr)
library(dplyr)
library(viridis)
library(ggthemes)
```




# BLR including WTP
```{r}
#data formatting 
choice<- read.csv("raw/version_to_package.csv", stringsAsFactors = TRUE) %>% 
  rename(survey_version = 1)

packages<- read.csv("raw/packages.csv", stringsAsFactors = TRUE)  %>% 
  rename(package = 1)

choice_package<-choice %>% 
  left_join(packages) %>% 
  mutate(choice = ifelse(package <=16,1,2))


survey <- read.csv("raw/master_survey_resp.csv", stringsAsFactors = TRUE) %>% 
  select(survey_id, survey_version, country, choice, package_nopackage, starts_with("wtp"), starts_with("wtr"))

pack_yes<- survey %>% 
  filter(package_nopackage == 1) %>% 
  mutate(wtp = ifelse(wtp_4== "y", 4,
                      ifelse(wtp_4== "n", 3,
                             ifelse(wtp_3=="n", 2,
                                    ifelse(wtp_2=="n", 1, 0))))) %>% 
  select(-starts_with("wtp_"), -starts_with("wtr_"), -package_nopackage) %>% 
  left_join(choice_package) %>% 
  mutate(choice=1)

pack_no <- survey %>% 
  filter(package_nopackage == 0) %>% 
  mutate(wtp = ifelse(wtr_4== "y", -4,
                      ifelse(wtr_4== "n", -5,
                             ifelse(wtr_3=="y", -3,
                                    ifelse(wtr_2=="y", -2, -1))))) %>% 
  select(-starts_with("wtp_"), -starts_with("wtr_"), -package_nopackage) %>% 
  left_join(choice_package) %>% 
  mutate(choice=1)

pack_no_no<-pack_no %>% 
  mutate(wtp=(wtp+1)) %>% 
  mutate(choice = 0)

pack_yes_no<-pack_yes %>% 
  filter(wtp!=4) %>% 
  mutate(wtp=(wtp+1)) %>% 
  mutate(choice = 0)

bind_pre<-rbind(pack_no,pack_yes, pack_no_no, pack_yes_no) %>% 
  filter(wtp!=-5)

other_pack<-bind_pre %>% 
  select(survey_id, survey_version, country,  choice) %>%
  mutate(choice = ifelse(choice == 1,2,1)) %>% 
  left_join(choice_package) %>% 
  mutate(choice=0) %>% 
  mutate(wtp=0)

bind<-rbind(bind_pre, other_pack) 

```

For IND

wtp_1 = $2.14
wtp_2 = $3.56
wtp_3 = $5.35
wtp_4 = $7.12

For MEX 

wtp_1 = $2.07
wtp_2 = $3.62
wtp_3 = $5.17
wtp_4 = $7.75

```{r}

bind_ind<-bind %>% 
  filter(country=="IND") %>% 
  mutate(wtp = ifelse(wtp == -4, -7.12,
                       ifelse(wtp == -3, -5.35, 
                              ifelse(wtp == -2, -3.56,
                                      ifelse(wtp == -1, -2.14, 
                                             ifelse(wtp == 0, 0, 
                                                    ifelse(wtp == 1, 2.14, 
                                                           ifelse(wtp == 2, 3.56, 
                                                                  ifelse(wtp == 3, 5.35, 7.12)))))))))

bind_mex<-bind %>% 
  filter(country=="MEX") %>% 
  mutate(wtp = ifelse(wtp == -4, -7.75,
                       ifelse(wtp == -3, -5.17, 
                              ifelse(wtp == -2, -3.62,
                                      ifelse(wtp == -1, -2.07, 
                                             ifelse(wtp == 0, 0, 
                                                    ifelse(wtp == 1, 2.07, 
                                                           ifelse(wtp == 2, 3.62, 
                                                                  ifelse(wtp == 3, 5.17, 7.75)))))))))

bind_wtp<-rbind(bind_mex,bind_ind) %>% 
  mutate(own=as.factor(own))


#making the df to be used for log-log
bind_log<-bind_wtp %>% 
  filter(choice == 1) %>% 
  mutate(sos = ifelse(sos==1,0,1)) %>% 
  mutate(info = ifelse(info == 2,0,1)) %>% 
  mutate(own=as.factor(own)) 

```


```{r}
wtp_distribution <-bind %>% 
  filter(choice == 1) %>% 
  select(wtp) %>%
  mutate(wtp_p4 = wtp + 4) %>% 
  mutate(log_wtp= log(wtp_p4)) %>% 
  gather(variable, value) 
  

wtp_distribution %>% 
 ggplot(aes(x = value, fill = variable)) +
    geom_bkde() +
    geom_rug() +
    scale_fill_viridis(guide = FALSE, discrete = TRUE) +
    facet_wrap(~variable, scales = "free") +
    theme_base()

```







# Adding variables Income, Education, Years Fishing, Age, Country

```{r}
variables_log<-survey %>% 
  select(survey_id, country, community, income, years_fishing, age, education)
  
#income conversion
#0.000071 USD / 1 Indonesian Rupiah 
#0.052 USD / 1 Medican Peso

library(WDI)

gdp_raw<- WDI(indicator = "NY.GDP.PCAP.KD", country=c("MX", "ID"), start = 2018, end = 2018) %>% 
  mutate(country=ifelse(country=="Mexico", "MEX", "IND")) %>% 
  rename(c = 1) %>% 
  select(-c, -year)

#community mean income to fill NA values for income

com_mean<-survey %>% 
  group_by(community) %>% 
  summarise(mean_income = mean(income, na.rm = TRUE))

variables_income<-survey %>% 
  select(survey_id, country, community, income) %>%
  left_join(com_mean) %>%
  mutate(gf_income = ifelse(is.na(income), 1, 0)) %>% 
  mutate(income = ifelse(is.na(income), mean_income, income)) %>% 
  mutate(currency = ifelse(country=="MEX", 0.052, 0.000071)) %>% 
  mutate(income_usd = currency*income*12) %>% 
  left_join(gdp_raw) %>% 
  mutate(gdp_prop = income_usd/NY.GDP.PCAP.KD)

gdp_prop<-variables_income %>% 
  select(survey_id, gdp_prop)
  

ggplot(variables_income, aes(x=income_usd))+
  geom_histogram()+
  facet_wrap(~country)
```


```{r}
#education
variables_edu<-survey %>% 
  select(survey_id, country, community, education) %>%  
  mutate(education=as.character(education)) %>% 
  mutate(education = ifelse(education == "other", "secondary", education)) 
```

Combining corrected variables (income and education) with years_fishing, age, community

```{r}
variables_log<-survey %>% 
  select(survey_id, country, community, years_fishing, age) %>% 
  left_join(variables_edu) %>% 
  left_join(gdp_prop)
```



```{r}
glm.fit <- glm(choice ~ sos + info + wtp + own, data = bind_wtp, family = binomial)
summary(glm.fit)
```

