---
title: "Hypothetical Village Data"
author: "Gage Clawson"
date: "1/16/2020"
output: html_document
---
** NOTE: You can skip to the bottom sections, "GRAPHS!", to load in the data files and make the graphs. It will save you a lot of time instead of re running the analysis. **


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(mefa)

total_sim_data <- read_csv("output/lm_15_allcombo_predictions.csv") %>%
  select(-X1)

set.seed(6969)

```

```{r}
# load necessary packages for importing the function
library(RCurl)
 
# import the function from repository
url_robust <- "https://raw.githubusercontent.com/IsidoreBeautrelet/economictheoryblog/master/robust_summary.R"
eval(parse(text = getURL(url_robust, ssl.verifypeer = FALSE)))
```

Puerto San Carlos; Based off of Jumbo Squid Fishery.
Paper: [Socioeconomic Diagnosis of the 2010 Jumbo Squid Artisanal Fishery near Magdalena Bay, Baja California Sur, Mexico](http://www.scielo.org.mx/scielo.php?script=sci_arttext&pid=S0188-88972014000100002)

Statistics: 
 - Population 5538 (2010 census data)
 - Artisanal Fisheries employ about 50% of the working population. 
 - 1800 fishing permits for jumbo squid 
   - "almost all of our respondents engage in other fisheries when jumbo squid are not present"
   - Assume that there are 1800 fishers in Puerto San Carlos. 
 - Average age is 34 years with a range of 18 to 78. 
 - No formal education (34%); formal (middle or high school; 30% + 33% = 63%); classify the remaining as higher (3%)
 - average of $11,090 Mexican Pesos each month (+/- $1,000 USD per month)
 - Assume biggest problem for the fishery is IUU. 
 - 8% did not have fishing communication technology on their boat. 

```{r}

# fishtech_yes <- 1800*0.92
# fishtech_no <- 1800*0.08
# 
# no_formal_edu <- 1800*0.34
# formal_edu <- 1800*0.63
# higher_edu <- 1800*0.03
# 
# iuu <- 1800
# 
# psc_filter <- total_sim_data %>%
#   filter(rank_one == "iuu", sos == 1, info == 0, own == 1)
wtpmin <- -5.35

fishtech <- c(0,1)
psc_prob_fishtech <- c(0.08, 0.92)
rank_one <- c("corruption", "pollution", "weather", "iuu")
education <- c("no_formal", "formal", "higher")
psc_prob_edu <- c(0.34, 0.63, 0.03)

psc <- data.frame(
                  fishtech = sample(rep(fishtech, round(1800*psc_prob_fishtech))),
                  education = sample(rep(education, round(1800*psc_prob_edu))),
                  rank_one = "iuu"
                  )



length(psc$fishtech[psc$fishtech ==0]) # this should be 144 !!!?
length(psc$fishtech[psc$fishtech ==1])

length(psc$education[psc$education == "no_formal"])
length(psc$education[psc$education == "formal"])
length(psc$education[psc$education == "higher"])

length(psc$rank_one[psc$rank_one == "iuu"])



sos <- c(0,1)
info <- c(0,1)
own <- c("1", "2", "3", "4")

packages <- expand.grid(sos = sos,info = info, own= own)

# new <- merge(psc,packages)
# new_filter <- new %>%
#   filter(sos == 1, info == 0, own == 1)
# 
# length(new_filter$education[new_filter$education == "no_formal"]) #612
# length(psc$rank_one[psc$rank_one == "iuu"]) #1800
# length(psc$fishtech[psc$fishtech == 1]) #1656
# ## IT WORKS!! 


psc_all_packages <- merge(psc, packages)

#write.csv(psc_all_packages, "hypo_village_data/PuertoSanCarlos.csv", row.names = FALSE)

## load in specific model 
load("output/lm_15.rda")
load("output/int_15.rda")

psc_predict <- data.frame(psc_all_packages, lm_15_wtp = exp(predict(wtp_lm_15, newdata = psc_all_packages)) - 1 + wtpmin, int_15_wtp = predict(int_15, newdata = psc_all_packages)) ## if you want to add predictions from another model, just tack it onto the end. Now we can filter for a technology and make graphs based off of that. 
packages <- read_csv("raw/packages.csv")  %>%
  filter(package <= 16) %>%
  mutate(sos = ifelse(sos==2,1,0), info=ifelse(info==2,0,1)) %>%
  mutate(own = factor(own))

psc_predict_packages <- left_join(psc_predict, packages)
#write.csv(psc_predict_packages, "hypo_village_data/PuertoSanCarlos_predictions.csv", row.names = FALSE)

## Make a list of data frames for each package combination. 
my_data_psc <- list()
for (i in unique(psc_predict_packages$package)) {
    my_data_psc[[i]] <- filter(psc_predict_packages, package == i)
}

#save(my_data_psc, file="hypo_village_data/psc_predict_by_package.RData") ## save this list to read back in for graphs.


```

```{r}

# read list in to begin making data usable to graph
load("hypo_village_data/psc_predict_by_package.RData")

mean(my_data_psc[[1]]$lm_15_wtp)
mean(my_data_psc[[1]]$int_15_wtp)
#write.csv(psc_predict, "hypo_village_data/PuertoSanCarlos_predictions.csv", row.names = FALSE)

test <- my_data_psc[[1]] ## this is psc with package 1 predictions. Can do the same for all 16 packages.

sim_total <- nrow(my_data_psc[[1]])
dollar_values <- seq(-3, 8, by = 0.01)

## Log Model Graph Data ##
system.time(new_data_log <- lapply(my_data_psc, function(x) {
  
  test_graph_df <- x %>%
  merge(dollar_values) %>%
  mutate(opt_in_log = ifelse(lm_15_wtp > y, 1, 0 )) %>% ## if the wtp is greater than payment value, then they will opt out, otherwise, opt in
  arrange(opt_in_log)

test_group_df <- test_graph_df %>%
  group_by(y, opt_in_log) %>%
  tally() %>%
  filter(opt_in_log == 1) %>% ## filter for all opt ins...
  mutate(perc_opt_in_log = n/sim_total) %>% ##384 total scenarios
  ungroup()
    
    # df1 <- data.frame(sample = all_samples, value = expr_filt_matrix[x, ])
    # df2 <- merge(df1, grade_df)
    # df2
}))

#save(new_data_log, file="hypo_village_data/psc_predict_log_graphdata.RData")

## Interval Model Graph Data ##
system.time(new_data_int <- lapply(my_data_psc, function(x) {
  
  test_graph_df <- x %>%
  merge(dollar_values) %>%
  mutate(opt_in_int = ifelse(int_15_wtp > y, 1, 0 )) %>% ## if the wtp is greater than payment value, then they will opt out, otherwise, opt in
  arrange(opt_in_int)

test_group_df <- test_graph_df %>%
  group_by(y, opt_in_int) %>%
  tally() %>%
  filter(opt_in_int == 1) %>% ## filter for all opt ins...
  mutate(perc_opt_in_int = n/sim_total) %>% ##384 total scenarios
  ungroup()
    
}))

#save(new_data_int, file="hypo_village_data/psc_predict_int_graphdata.RData")

```

## GRAPHS!

```{r}
## plot log log acceptance rate ##
load(file="hypo_village_data/psc_predict_log_graphdata.RData")

ggplot(new_data_log[[7]], aes(x = y, y = perc_opt_in_log)) +
  geom_point() +
  geom_line() +
  labs(x = "Payment to Fisher ($/month)", y = "Percent opt in VMS Program", title = "All Technology and Demographic Combinations") +
  theme_bw() +
  scale_x_continuous(breaks = seq(-3,8, 1))

## plot interval regression acceptance rate ##
load(file="hypo_village_data/psc_predict_int_graphdata.RData")

ggplot(new_data_log[[7]], aes(x = y, y = perc_opt_in_log)) +
  geom_point() +
  geom_line() +
  labs(x = "Fisher Payment ($/month)", y = "Percent opt in VMS Program", title = "Package 7 Puerto San Carlos") +
  theme_bw() +
  scale_x_continuous(breaks = seq(-3,8, 1))
```

